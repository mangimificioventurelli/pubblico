<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lista Partenza</title>
<style>
body { font-family: Arial, sans-serif; margin: 10px; }
h2 { text-align: center; }
table { border-collapse: collapse; width: 100%; table-layout: fixed; word-wrap: break-word; }
th, td { border: 1px solid #aaa; padding: 6px; text-align: left; }
tr.selected { background-color: #d0f0d0; }
tbody tr:hover { background-color: #f0f0f0; cursor: pointer; }
.container { overflow-x: auto; }
</style>
</head>
<body>
<h2>Lista Partenza</h2>
<div class="container">
<table id="tabellaPartenza">
<thead>
<tr>
<th>Indice</th>
<th>Testo OCR</th>
<th>Estrattore</th>
<th>Prodotto Normalizzato</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<script>
const mapping = {
    "RANTURCI": "GRANTURCO",
    "GRANTURCI": "GRANTURCO",
    "MANGOOA": "GRANTURCO"
};

function normalizzaProdotto(testo) {
    // estrai tutto dopo il codice prodotto (es. MAN00002000000)
    const match = testo.match(/[A-Z0-9]{6,}\s+(.*)$/);
    let prod = match ? match[1] : testo;
    
    // applica correzioni OCR
    for (let k in mapping) {
        if (prod.includes(k)) prod = prod.replace(k, mapping[k]);
    }
    return prod.trim();
}

function estraiEstrattore(testo) {
    const parti = testo.split(" ");
    return parti.length >= 2 ? parti[1] : "";
}

let selectedIdx = null;

async function caricaLista() {
    const listaResp = await fetch("https://travasoventurelli-default-rtdb.europe-west1.firebasedatabase.app/lista.json");
    const lista = await listaResp.json() || [];
    
    const prodResp = await fetch("https://travasoventurelli-default-rtdb.europe-west1.firebasedatabase.app/prodotto.json");
    const prodottoDest = await prodResp.json() || "";

    const tbody = document.querySelector("#tabellaPartenza tbody");
    tbody.innerHTML = "";

    lista.forEach(item => {
        const estrattore = estraiEstrattore(item.testo);
        const prodNorm = normalizzaProdotto(item.testo);
        const selectedClass = prodNorm.includes(prodottoDest) ? "selected" : "";

        const tr = document.createElement("tr");
        tr.className = selectedClass;
        tr.innerHTML = `<td>${item.idx}</td><td>${item.testo}</td><td>${estrattore}</td><td>${prodNorm}</td>`;

        tr.addEventListener("click", () => {
            if (selectedIdx !== null) {
                tbody.querySelectorAll("tr")[selectedIdx].classList.remove("selected");
            }
            tr.classList.add("selected");
            selectedIdx = item.idx;
            console.log("Selezionato indice:", selectedIdx, "Prodotto:", prodNorm);
        });

        tbody.appendChild(tr);
    });
}

caricaLista();
</script>
</body>
</html>
