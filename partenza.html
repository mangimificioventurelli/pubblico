<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Selezione Partenza</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f4f4;
  padding: 20px;
}

h2 {
  margin-bottom: 10px;
}

table {
  border-collapse: collapse;
  width: 100%;
  background: white;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px 8px;
  font-size: 14px;
}

th {
  background: #eee;
}

tr:hover {
  background: #dff0ff;
  cursor: pointer;
}

.info {
  margin-bottom: 10px;
  font-weight: bold;
}
</style>
</head>

<body>

<h2>Lista Partenze filtrata</h2>
<div class="info" id="info">Caricamento...</div>

<table>
<thead>
<tr>
  <th>Idx</th>
  <th>Estrattore</th>
  <th>Prodotto</th>
  <th>Testo OCR</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script>
const FIREBASE_BASE = "https://travasoventurelli-default-rtdb.europe-west1.firebasedatabase.app";

/* ===================== UTIL ===================== */

function normalize(txt) {
  return txt
    .toUpperCase()
    .replace(/[^A-Z0-9 ]/g, " ")
    .replace(/\s+/g, " ")
    .trim();
}

function estraiEstrattore(testo) {
  const m = normalize(testo).match(/\b(\d{1,3})\b/);
  return m ? m[1] : "";
}

function estraiProdotto(testo) {
  const parti = normalize(testo).split(" ");

  let start = -1;
  for (let i = 0; i < parti.length; i++) {
    if (/^[A-Z]{4,}$/.test(parti[i])) {
      start = i;
      break;
    }
  }
  if (start === -1) return "";

  return parti.slice(start).join(" ");
}

/* ===================== FIREBASE ===================== */

async function fbGet(path) {
  const r = await fetch(FIREBASE_BASE + path);
  return r.json();
}

async function fbPut(path, value) {
  await fetch(FIREBASE_BASE + path, {
    method: "PUT",
    body: JSON.stringify(value)
  });
}

/* ===================== MAIN ===================== */

async function main() {
  const info = document.getElementById("info");
  const tbody = document.getElementById("tbody");

  const prodottoDest = (await fbGet("/dest/prodotto.json")) || "";
  const lista = (await fbGet("/partenza/lista.json")) || [];

  if (!prodottoDest) {
    info.textContent = "Prodotto DEST non trovato";
    return;
  }

  info.textContent = "Prodotto selezionato: " + prodottoDest;

  const keyDest = normalize(prodottoDest);

  const filtrata = lista.filter(item => {
    const prod = estraiProdotto(item.testo);
    return prod === keyDest;
  });

  if (filtrata.length === 0) {
    info.textContent += " (nessuna partenza trovata)";
    return;
  }

  filtrata.forEach(item => {
    const tr = document.createElement("tr");

    const estr = estraiEstrattore(item.testo);
    const prod = estraiProdotto(item.testo);

    tr.innerHTML = `
      <td>${item.idx}</td>
      <td>${estr}</td>
      <td>${prod}</td>
      <td>${item.testo}</td>
    `;

    tr.onclick = async () => {
      await fbPut("/partenza/select.json", item.idx);
      alert("Indice selezionato: " + item.idx);
    };

    tbody.appendChild(tr);
  });
}

main();
</script>

</body>
</html>
