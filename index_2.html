<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checklist Partenza</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: #111;
  color: #fff;
  font-family: system-ui, sans-serif;
}

.app {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px;
  gap: 20px;
}

h1 {
  margin: 0;
}

#info {
  font-size: 18px;
  opacity: 0.9;
}

#lista {
  display: flex;
  flex-direction: column;
  gap: 14px;
  width: 100%;
  max-width: 500px;
}

button {
  padding: 16px;
  font-size: 20px;
  border-radius: 14px;
  border: none;
  background: #1e90ff;
  color: #fff;
  cursor: pointer;
}

button:hover {
  opacity: 0.85;
}
</style>
</head>

<body>

<div class="app">
  <h1>Checklist Partenza</h1>
  <div id="info">⏳ In attesa lista...</div>
  <div id="lista"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  /* ================== CONFIG ================== */

  const BASE =
    "https://travasoventurelli-default-rtdb.europe-west1.firebasedatabase.app";

  const LISTA_URL  = BASE + "/partenza/lista.json";
  const SELECT_URL = BASE + "/partenza/select.json";

  const info = document.getElementById("info");
  const listaDiv = document.getElementById("lista");

  if (!info || !listaDiv) {
    console.error("Elementi DOM mancanti");
    return;
  }

  /* ================== CARICAMENTO LISTA ================== */

  async function caricaChecklist() {
    try {
      const r = await fetch(LISTA_URL);
      const lista = await r.json();

      if (!lista || Object.keys(lista).length === 0) {
        info.innerText = "⏳ In attesa lista partenze...";
        return;
      }

      renderLista(lista);

    } catch (e) {
      console.error("Errore checklist:", e);
      info.innerText = "❌ Errore caricamento checklist";
    }
  }

  /* ================== RENDER ================== */

  function renderLista(lista) {
    listaDiv.innerHTML = "";
    info.innerText = "Seleziona l’estrattore:";

    lista.forEach(voce => {
      const btn = document.createElement("button");
      btn.innerText = voce.testo;
      btn.onclick = () => selezionaPartenza(voce);
      listaDiv.appendChild(btn);
    });
  }

  /* ================== SELEZIONE ================== */

  async function selezionaPartenza(voce) {
    info.innerText = "⏳ Invio selezione...";
    listaDiv.innerHTML = "";

    try {
      // invio selezione ad AHK
      await fetch(SELECT_URL, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(voce)
      });

      // ORA (e solo ora) posso consumare la lista
      await fetch(LISTA_URL, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(null)
      });

      info.innerText = "✅ Selezione inviata. Attendere verifica...";

    } catch (e) {
      console.error("Errore selezione:", e);
      info.innerText = "❌ Errore invio selezione";
    }
  }

  /* ================== AVVIO ================== */

  caricaChecklist();

});
</script>

</body>
</html>
