<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Checklist Partenza</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body {
  font-family: Arial, sans-serif;
  background: #111;
  color: #eee;
  margin: 0;
  padding: 10px;
}

h2 {
  text-align: center;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
  margin-bottom: 20px;
}

th, td {
  padding: 6px;
  border-bottom: 1px solid #333;
}

th {
  background: #222;
  position: sticky;
  top: 0;
}

tr {
  cursor: pointer;
}

tr.selected {
  background: #ffd966;
}  

tr:hover {
  background: #2a2a2a;
}

button {
  padding: 12px 24px;
  font-size: 16px;
  font-weight: bold;
  border-radius: 12px;
  border: none;
  color: white;
  background: #0077ff;
  margin: 0 auto;
  display: block;
  cursor: pointer;
}

button:active {
  transform: scale(0.97);
  opacity: 0.85;
}
</style>
</head>

<body>

<h2>CHECKLIST PARTENZA</h2>

<table id="tbl">
  <thead>
    <tr>
      <th>Idx</th>
      <th>Prodotto</th>
      <th>Estrattore</th>
      <th>Testo OCR</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<button onclick="tornaIndex()">Torna a Start/Stop</button>

<script>
const FIREBASE = "https://travasoventurelli-default-rtdb.europe-west1.firebasedatabase.app";

  const LISTA_URL = BASE + "/partenza/lista.json";



/* =================== UTILS =================== */
function norm(s) {
  return s.toUpperCase().replace(/0/g,"O").replace(/1/g,"I").replace(/[^A-Z ]/g,"").replace(/\s+/g," ").trim();
}

function estraiProdotto(testo) {
  const t = norm(testo);
  const prodotti = ["GRANTURCO SCHIACCIATO SF","GRANTURCO","ORZO","FARINA DI SOIA","FIOCCHI DI SOIA","FARINA DI GIRASOLE","CRUSCA DI FRUMENTO","POLPA DI BARBABIETOLE","GUSCI DI SEMI"];
  for(const p of prodotti) if(t.includes(p)) return p;
  return "";
}

function estraiEstrattore(testo){
  let m = testo.match(/\bS\d{1,2}\b/) || testo.match(/\$\d{1,2}/) || testo.match(/\b\d{1,2}\b/);
  return m ? m[0] : "";
}

/* =================== FIREBASE =================== */
async function fbGet(path){
  const r = await fetch(FIREBASE + path + ".json");
  return await r.json();
}

async function fbSet(path,val){
  await fetch(FIREBASE + path + ".json",{
    method:"PUT",
    body: JSON.stringify(val)
  });
}

/* =================== MAIN =================== */
async function main(){
  const destProdRaw = await fbGet("/dest/prodotto");
  const destProd = norm(destProdRaw || "");

  const data = await fbGet("/partenza/lista");
  if(!data || typeof data !== "object") return;

  const tbody = document.querySelector("#tbl tbody");
  tbody.innerHTML = "";

  for(const key in data){
    const row = data[key];
    if(!row || !row.testo) continue;

    const prodotto = estraiProdotto(row.testo);
    if(!prodotto) continue;
    if(destProd && !prodotto.includes(destProd)) continue;

    const estr = estraiEstrattore(row.testo);

    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${key}</td><td>${prodotto}</td><td>${estr}</td><td>${row.testo}</td>`;

    // dati coerenti
    tr.dataset.idx = Number(key);
    tr.dataset.part = prodotto;
    tr.dataset.dest = destProd;

    // clic su riga
    tr.onclick = async function(){
      // evidenzia la riga
      document.querySelectorAll("#tbl tr").forEach(r => r.classList.remove("selected"));
      this.classList.add("selected");

      // payload per Firebase
      const payload = {
        idx: this.dataset.idx,
        part: this.dataset.part,
        dest: this.dataset.dest,
        ts: Date.now()
      };

      console.log("SCRIVO FIREBASE:", payload);
      await fbSet("/partenza/select", payload);

      // conferma e ritorno
      const conferma = confirm(`Hai selezionato:\nPRODOTTO: ${payload.part}\nVuoi tornare alla schermata principale?`);
      if(conferma){
        window.location.href = "index_3.html";
      }
    };

    tbody.appendChild(tr);
  }
}

function tornaIndex(){
  window.location.href = "index_3.html";
}

/* =================== START =================== */
main();

  async function caricaChecklist() {
  const r = await fetch(LISTA_URL);
  const lista = await r.json();

  if (!lista || Object.keys(lista).length === 0) {
    info.innerText = "‚è≥ In attesa lista...";
    return;
  }

  renderLista(lista);
}

caricaChecklist();
</script>

</body>
</html>
