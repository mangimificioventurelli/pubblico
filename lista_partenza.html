<table id="tabellaPartenza">
  <thead>
    <tr>
      <th>Indice</th>
      <th>Testo</th>
      <th>Prodotto</th>
      <th>Estrattore</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const firebaseBase = "https://travasoventurelli-default-rtdb.europe-west1.firebasedatabase.app/";
const listaUrl = firebaseBase + "/partenza/lista.json";

async function caricaLista() {
    const r = await fetch(listaUrl);
    const lista = await r.json();
    const tbody = document.querySelector("#tabellaPartenza tbody");
    tbody.innerHTML = "";

    for (const item of lista) {
        const parti = item.testo.split(" ");
        const prodotto = parti.slice(2).join(" ");
        const estrattore = parti[1].replace(/\D/g, ""); // prende solo i numeri della seconda colonna

        const tr = document.createElement("tr");
        tr.dataset.idx = item.idx;
        tr.dataset.prodotto = prodotto;
        tr.dataset.estrattore = estrattore;
        tr.innerHTML = `<td>${item.idx}</td><td>${item.testo}</td><td>${prodotto}</td><td>${estrattore}</td>`;
        tbody.appendChild(tr);
    }
}

function filtraLista() {
    const filtro = document.getElementById("filtroProdotto").value.toUpperCase();
    const rows = document.querySelectorAll("#tabellaPartenza tbody tr");
    rows.forEach(row => {
        const prod = row.dataset.prodotto.toUpperCase();
        row.style.display = prod.includes(filtro) ? "" : "none";
    });
}

function selezionaElemento(tr) {
    document.querySelectorAll("#tabellaPartenza tbody tr").forEach(r => r.classList.remove("selected"));
    tr.classList.add("selected");

    const estrattore = tr.dataset.estrattore;
    // invio estrattore selezionato a Firebase per AHK
    fetch(firebaseBase + "/partenza/select.json", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(estrattore)
    });
}

document.getElementById("filtroProdotto").addEventListener("input", filtraLista);
document.querySelector("#tabellaPartenza tbody").addEventListener("click", e => {
    let tr = e.target.closest("tr");
    if (tr) selezionaElemento(tr);
});

caricaLista();
</script>
