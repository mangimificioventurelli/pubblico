<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Selezione Partenza</title>
<style>
  table { border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid #ccc; padding: 5px; text-align: left; }
  tr.selected { background-color: #ffa; }
</style>
</head>
<body>

<h2>Lista Estrattori Partenza</h2>

<label>Filtra per prodotto: <input type="text" id="filtroProdotto"></label>
<table id="tabella">
  <thead>
    <tr>
      <th>Indice</th>
      <th>Testo</th>
      <th>Prodotto</th>
      <th>Estrattore</th>
    </tr>
  </thead>
  <tbody>
    <!-- righe generate dinamicamente -->
  </tbody>
</table>

<button id="invia">Invia selezione a Firebase</button>

<script>
const firebaseBase = "https://travasoventurelli-default-rtdb.europe-west1.firebasedatabase.app/";
let listaPartenza = [];
let rigaSelezionata = null;

// Carica lista da Firebase
async function caricaLista() {
  try {
    const res = await fetch(`${firebaseBase}/partenza/lista.json`);
    const data = await res.json();

    listaPartenza = [];
    for (let i in data) {
      const item = data[i];
      // estrattore = prime 2 cifre della colonna testo
      const estrattore = item.testo.split(" ")[0].replace(/\D/g,"");
      listaPartenza.push({
    idx: item.idx,
    testo: item.testo,
    prodotto: item.testo.split(" ").slice(2).join(" "), // tutto tranne indice ed estrattore
    estrattore: item.testo.split(" ")[0].replace(/\D/g,"")
});
    }

    mostraTabella(listaPartenza);
  } catch(e) {
    console.error("Errore caricamento lista:", e);
  }
}

// Mostra tabella filtrando per input
function mostraTabella(lista) {
  const tbody = document.querySelector("#tabella tbody");
  tbody.innerHTML = "";
  const filtro = document.querySelector("#filtroProdotto").value.toUpperCase();

  lista.forEach(item => {
    if (filtro && !item.prodotto.toUpperCase().includes(filtro)) return;

    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${item.idx}</td>
                    <td>${item.testo}</td>
                    <td>${item.prodotto}</td>
                    <td>${item.estrattore}</td>`;
    tr.onclick = () => {
      document.querySelectorAll("tr.selected").forEach(r => r.classList.remove("selected"));
      tr.classList.add("selected");
      rigaSelezionata = item.idx;
    };
    tbody.appendChild(tr);
  });
}

// Filtro dinamico
document.querySelector("#filtroProdotto").addEventListener("input", () => {
  mostraTabella(listaPartenza);
});

// Invio selezione a Firebase
document.querySelector("#invia").addEventListener("click", async () => {
  if (rigaSelezionata === null) {
    alert("Seleziona una riga!");
    return;
  }
  try {
    await fetch(`${firebaseBase}/partenza/select.json`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(rigaSelezionata)
    });
    alert("Selezione inviata a Firebase: " + rigaSelezionata);
  } catch(e) {
    console.error("Errore invio Firebase:", e);
  }
});

caricaLista();
</script>

</body>
</html>
