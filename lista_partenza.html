<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Selezione Partenza</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  tr:hover { background-color: #f0f0f0; cursor: pointer; }
  .selected { background-color: #cce5ff !important; }
</style>
</head>
<body>

<h2>Lista Estrattori Partenza</h2>
<label>Filtra per prodotto: <span id="prodottoDest"></span></label>
<table id="listaPartenza">
  <thead>
    <tr><th>Indice</th><th>Testo</th></tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const firebaseBase = "https://travasoventurelli-default-rtdb.europe-west1.firebasedatabase.app/";
let prodottoDest = "";

// Funzione per leggere il prodotto selezionato da Firebase
async function fetchProdottoDest() {
  try {
    const res = await fetch(firebaseBase + "/dest/select.json");
    const data = await res.json();
    if(data) {
      prodottoDest = data; // se il JSON è solo il nome del prodotto
      document.getElementById("prodottoDest").innerText = prodottoDest;
      loadListaPartenza();
    }
  } catch(e) {
    console.error("Errore fetch prodottoDest:", e);
  }
}

// Carica lista partenza e mostra tabella
async function loadListaPartenza() {
  try {
    const res = await fetch(firebaseBase + "/partenza/lista.json");
    const lista = await res.json();
    const tbody = document.querySelector("#listaPartenza tbody");
    tbody.innerHTML = "";

    lista.forEach(item => {
      // Se prodottoDest non è vuoto, filtriamo
      if(!prodottoDest || item.testo.includes(prodottoDest)) {
        const tr = document.createElement("tr");
        tr.dataset.idx = item.idx;
        tr.innerHTML = `<td>${item.idx}</td><td>${item.testo}</td>`;
        tr.addEventListener("click", () => selezionaVoce(item.idx, tr));
        tbody.appendChild(tr);
      }
    });
  } catch(e) {
    console.error("Errore fetch listaPartenza:", e);
  }
}

// Invia l’indice selezionato a Firebase
async function selezionaVoce(idx, row) {
  document.querySelectorAll("#listaPartenza tr").forEach(r => r.classList.remove("selected"));
  row.classList.add("selected");

  try {
    await fetch(firebaseBase + "/partenza/select.json", {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(idx)
    });
  } catch(e) {
    console.error("Errore invio indice:", e);
  }
}

// Primo caricamento
fetchProdottoDest();

// Aggiornamento automatico ogni 2 secondi
setInterval(fetchProdottoDest, 2000);
</script>

</body>
</html>
