<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Selezione Partenza</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
table { border-collapse: collapse; width: 100%; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
th { background-color: #f0f0f0; }
tr:hover { background-color: #e0f7ff; cursor: pointer; }
.selected { background-color: #a0e0a0 !important; }
</style>
</head>
<body>
<h2>Lista Estrattori - Filtrata per prodotto</h2>
<table id="listaPartenza">
<thead>
<tr>
<th>Indice</th>
<th>Testo</th>
<th>Prodotto</th>
<th>Estrattore</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
const firebaseBase = "https://travasoventurelli-default-rtdb.europe-west1.firebasedatabase.app/"; // cambia con il tuo URL
let listaCompleta = [];
let prodottoDest = "";

// Legge il prodottoDest da Firebase
async function fetchProdottoDest() {
    const resp = await fetch(`${firebaseBase}/destinazione/prodotto.json`);
    prodottoDest = await resp.text();
    prodottoDest = prodottoDest.replace(/"/g,""); // pulizia stringa
}

// Legge la lista completa da Firebase
async function fetchListaPartenza() {
    const resp = await fetch(`${firebaseBase}/partenza/lista.json`);
    const data = await resp.json();
    listaCompleta = data || [];
}

// Mostra la tabella filtrata
function renderTable() {
    const tbody = document.querySelector("#listaPartenza tbody");
    tbody.innerHTML = "";

    const filtrata = listaCompleta.filter(item => item.prodotto.includes(prodottoDest));

    filtrata.forEach(item => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${item.idx}</td>
            <td>${item.testo}</td>
            <td>${item.prodotto}</td>
            <td>${item.estrattore}</td>
        `;
        tr.addEventListener("click", () => selectItem(item.idx, tr));
        tbody.appendChild(tr);
    });
}

// Invia indice selezionato a Firebase
async function selectItem(idx, tr) {
    document.querySelectorAll("tr.selected").forEach(r => r.classList.remove("selected"));
    tr.classList.add("selected");

    await fetch(`${firebaseBase}/partenza/select.json`, {
        method: "PUT",
        body: JSON.stringify(idx)
    });
}

// Ciclo iniziale: prendi prodottoDest → lista → render tabella
async function init() {
    await fetchProdottoDest();
    await fetchListaPartenza();
    renderTable();
}

// Aggiorna tabella ogni 3 secondi in caso di cambio Firebase
setInterval(async () => {
    await fetchProdottoDest();
    await fetchListaPartenza();
    renderTable();
}, 3000);

init();
</script>
</body>
</html>
