<script>
const BASE = "https://travasoventurelli-default-rtdb.europe-west1.firebasedatabase.app";

const PESO_URL  = BASE + "/peso.json";
const CMD_URL   = BASE + "/cmd.json";
const STATO_URL = BASE + "/stato.json";

const btnStart = document.querySelector(".btn-start");
const btnStop  = document.querySelector(".btn-stop");
const btnReset = document.querySelector(".btn-reset");

let lock = false;

/* ===== PESO ===== */
async function aggiornaPeso() {
  try {
    const r = await fetch(PESO_URL);
    const peso = await r.json();
    if (peso !== null && peso !== "") {
      document.getElementById("peso").innerText = peso;
    }
  } catch (e) {}
}
setInterval(aggiornaPeso, 500);

/* ===== UI ===== */
function aggiornaUI(stato) {
  if (!stato) return;

  stato = stato.toLowerCase();

  const operativo =
    stato === "marcia" ||
    stato === "automatico" ||
    stato === "svuotamento";

  btnStart.style.display = operativo ? "block" : "none";
  btnStop.style.display  = operativo ? "block" : "none";
  btnReset.style.display = "block";
}

/* ===== STATO ===== */
setInterval(async () => {
  try {
    const r = await fetch(STATO_URL);
    const stato = await r.json();

    if (!stato) return;

    document.getElementById("stato").innerText =
      "STATO: " + stato;

    aggiornaUI(stato);
  } catch (e) {}
}, 1000);

/* ===== COMANDI ===== */
async function sendCmd(cmd) {
  if (lock) return;
  lock = true;

  if (navigator.vibrate) navigator.vibrate(30);

  await fetch(CMD_URL, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(cmd)
  });

  setTimeout(() => lock = false, 1000);
}

async function stopCmd() {
  if (lock) return;

  if (!window.stopArmed) {
    window.stopArmed = true;
    await sendCmd("stop");
    return;
  }

  if (confirm("Confermi STOP macchina?")) {
    await sendCmd("stop_confirm");
  }

  window.stopArmed = false;
}
</script>
