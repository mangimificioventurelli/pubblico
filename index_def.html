<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bilancia</title>

<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: #111;
    color: #fff;
  }

  .app {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100%;
    gap: 28px;
  }

  #peso {
    font-size: 72px;
    font-weight: bold;
  }

  #stato {
    font-size: 36px;
    padding: 12px 24px;
    border-radius: 12px;
    background: #222;
  }

  .buttons {
    display: flex;
    flex-direction: column;
    gap: 24px;
    width: 80%;
    max-width: 360px;
  }

  button {
    height: 72px;
    font-size: 26px;
    font-weight: bold;
    border-radius: 18px;
    border: none;
    color: white;
    touch-action: manipulation;
  }

  .btn-start { background: #00a84f; }
  .btn-stop  { background: #d72626; }
  .btn-reset { background: #555; }

  button:active {
    transform: scale(0.97);
    opacity: 0.85;
  }
</style>
</head>

<body>

<div class="app">
  <div id="peso">---</div>
  <div id="stato">STATO: ---</div>
  <div class="buttons">
    <button class="btn-start" onclick="sendCmd('start')">START</button>
    <button class="btn-stop" onclick="stopCmd()">STOP</button>
    <button class="btn-reset" onclick="sendCmd('reset')">RESET ALLARMI</button>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const BASE     = "https://travasoventurelli-default-rtdb.europe-west1.firebasedatabase.app";
  const PESO_URL = BASE + "/peso.json";
  const STATO_URL = BASE + "/stato.json";
  const CMD_URL  = BASE + "/cmd.json";

  const btnStart = document.querySelector(".btn-start");
  const btnStop  = document.querySelector(".btn-stop");
  const btnReset = document.querySelector(".btn-reset");

  let lock = false;

  /* ===== FUNZIONE PER AGGIORNARE LA UI ===== */
  function aggiornaUI(stato) {
    if (!stato) return;

    stato = stato.toLowerCase();

    const operativo = ["marcia","automatico","svuotamento"].includes(stato);

    btnStart.style.display = operativo ? "block" : "none";
    btnStop.style.display  = operativo ? "block" : "none";
    btnReset.style.display = "block";
  }

  /* ===== LETTURA PESO ===== */
  async function aggiornaPeso() {
    try {
      const r = await fetch(PESO_URL);
      const peso = await r.json();
      if (peso !== null && peso !== "") {
        document.getElementById("peso").innerText = peso;
      }
    } catch (e) { console.error("Errore peso:", e); }
  }
  setInterval(aggiornaPeso, 500);

  /* ===== LETTURA STATO ===== */
  async function aggiornaStato() {
    try {
      const r = await fetch(STATO_URL);
      const stato = await r.json();
      if (stato) {
        document.getElementById("stato").innerText = "STATO: " + stato;
        aggiornaUI(stato);
      }
    } catch(e) { console.error("Errore stato:", e); }
  }
  setInterval(aggiornaStato, 1000);

  /* ===== INVIO COMANDI ===== */
  async function sendCmd(cmd) {
    if (lock) return;
    lock = true;
    if (navigator.vibrate) navigator.vibrate(30);

    try {
      await fetch(CMD_URL, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(cmd)
      });
    } catch(e) { console.error("Errore comando:", e); }

    setTimeout(() => lock = false, 1000);
  }

  async function stopCmd() {
    if (lock) return;

    if (!window.stopArmed) {
      window.stopArmed = true;
      await sendCmd("stop");
      return;
    }

    if (confirm("Confermi STOP macchina?")) {
      await sendCmd("stop_confirm");
    }

    window.stopArmed = false;
  }
});
</script>

</body>
</html>
